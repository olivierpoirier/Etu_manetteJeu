<!doctype html>
<html>
  <head>
    <script src="https://pixijs.download/release/pixi.js"></script>
  </head>
  <body>
    <script type="module">

      function keyDown(e) {
          console.log(e.keyCode);
          keys[e.keyCode] = true;
      }

      function keyUp(e) {
          console.log(e.keyCode);
          keys[e.keyCode] = false;
      }

      function movementControll(isTouchedByWallByRight, isTouchedByWallByLeft, isTouchedByWallByTop, isTouchedByWallByBottom) {
        if(!isTouchedByWallByTop) {
          if(keys["38"]){
              sprite.y -= 3;
            }
        }
        if(!isTouchedByWallByBottom) {
          if(keys["40"]){
            sprite.y += 3;
          }
        }
        if (!isTouchedByWallByLeft) {
          if(keys["37"]){
            sprite.x -= 3;
          }
        }
        if (!isTouchedByWallByRight) {
          if(keys["39"]){
          sprite.x += 3;
          }
        }

      }
        const app = new PIXI.Application();
        let keys = {};
        let keysDiv;
        let wallSprites = [];
        let timeStart = new Date;
        let startedSpawning = false
        await app.init({ background: 'black', width: 640, height: 500 });
      
        document.body.appendChild(app.canvas);

        // Create the sprite and add it to the stage
        await PIXI.Assets.load('square.png');
        let sprite = PIXI.Sprite.from('square.png');
        sprite.width = 50;
        sprite.height = 50;
        app.stage.addChild(sprite);
        
        window.addEventListener("keydown", keyDown);
        window.addEventListener("keyup", keyUp);
        keysDiv = document.querySelector("#keys");
        // Add a ticker callback to move the sprite back and forth
        let elapsed = 0.0;
        app.ticker.add((ticker) => {
          let nowTime = new Date;
          let isTouchedByWallByTop = false;
          let isTouchedByWallByLeft = false;
          let isTouchedByWallByBottom = false;
          let isTouchedByWallByRight = false;

          //keysDiv.innerHTML = JSON.stringify(keys);
          elapsed += ticker.deltaTime;

          if (nowTime.getSeconds() - timeStart.getSeconds() >= 5 && !startedSpawning) {
            startedSpawning = true;
            console.log("spawn");
            let wallSprite = PIXI.Sprite.from('square.png');
            wallSprite.width = 50;
            wallSprite.height = 50;
            wallSprite.x = 600;
            wallSprite.y = 150;
            app.stage.addChild(wallSprite);

            let wallSprite2 = PIXI.Sprite.from('square.png');
            wallSprite2.width = 50;
            wallSprite2.height = 50;
            wallSprite2.x = 300;
            wallSprite2.y = 100;
            //Faire le random
            //wallSprite.y = Math.random(0,150);
            app.stage.addChild(wallSprite2);
            wallSprites.push(wallSprite);
            wallSprites.push(wallSprite2);
          }

          

          wallSprites.forEach(wall => {
            if (sprite.x  < wall.x + wall.width 
            && sprite.x + sprite.width > wall.x
            && sprite.y < wall.y + wall.height
            && sprite.y + sprite.height > wall.y){
            if (sprite.x  < wall.x + wall.width) {
              isTouchedByWallByLeft = true;
              
            }

            if (sprite.x + sprite.width > wall.x -10 && sprite.x + sprite.width < wall.x + wall.width -wall.width /2) {
              isTouchedByWallByRight = true;
              sprite.x -=2;
            }

            if (sprite.y + sprite.height > wall.y -10 && sprite.y + sprite.height < wall.y + wall.height -wall.height /2) {
              isTouchedByWallByBottom = true;
            }

            if (sprite.y - sprite.height < wall.y +10 && sprite.y - sprite.height > wall.y - wall.height +wall.height /2) {
              isTouchedByWallByTop = true;
            }

            console.log(isTouchedByWallByRight);
          }

          wall.x -=2;
          
          });

          movementControll(isTouchedByWallByRight, isTouchedByWallByLeft, isTouchedByWallByTop, isTouchedByWallByBottom);
          //console.log(isTouchedByWallByRight);
          
          //sprite.x = 100.0 + Math.cos(elapsed/50.0) * 100.0;
          
        });
    </script>
  </body>
</html>