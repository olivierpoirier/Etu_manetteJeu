<!doctype html>
<html>
  <head>
    <script src="https://pixijs.download/release/pixi.js"></script>
  </head>
  <body>
    <script type="module">

      function keyDown(e) {
          console.log(e.keyCode);
          keys[e.keyCode] = true;
      }

      function keyUp(e) {
          console.log(e.keyCode);
          keys[e.keyCode] = false;
      }

      function spawnWall() {
        console.log("spawn");
        let wallSprite = PIXI.Sprite.from('square.png');
        wallSprite.width = 50;
        wallSprite.height = 50;
        wallSprite.x = gameWidth;
        wallSprite.y = Math.floor(Math.random() * (gameHeight-wallSprite.height));
        app.stage.addChild(wallSprite);
        wallSprites.push(wallSprite);
        isWallSpawning = false;
        
          
      }

      function movementControll(isTouchedByWallByRight, isTouchedByWallByLeft, isTouchedByWallByTop, isTouchedByWallByBottom) {
        if(sprite.y >= 0){
          if(!isTouchedByWallByTop) {
            if(keys["38"]){
              sprite.y -= speedOfPlayer;
            }
          }
        }
        if(sprite.y < gameHeight - sprite.height){
          if(!isTouchedByWallByBottom) {
            if(keys["40"]){
              sprite.y += speedOfPlayer;
            }
          }
        }
        if (!isTouchedByWallByLeft) {
          if(keys["37"]){
            sprite.x -= speedOfPlayer;
          }
        }
        if (!isTouchedByWallByRight) {
          if(keys["39"]){
          sprite.x += speedOfPlayer;
          }
        }

      }
        const app = new PIXI.Application();
        let keys = {};
        let keysDiv;
        let wallSprites = [];
        let timeStart = new Date;
        let startedSpawning = false;
        let isWallSpawning = false;

        const gameWidth = 1000;
        const gameHeight = 500;
        const speedOfWalls = 2;
        const speedOfPlayer = 3;
        const playerWidth = 15;
        const playerHeight = 15;

        await app.init({ background: 'black', width: gameWidth, height: gameHeight });
      
        document.body.appendChild(app.canvas);

        // Create the sprite and add it to the stage
        await PIXI.Assets.load('square.png');
        let sprite = PIXI.Sprite.from('square.png');
        sprite.width = playerWidth;
        sprite.height = playerHeight;
        app.stage.addChild(sprite);
        
        window.addEventListener("keydown", keyDown);
        window.addEventListener("keyup", keyUp);
        keysDiv = document.querySelector("#keys");
        // Add a ticker callback to move the sprite back and forth
        let elapsed = 0.0;
        app.ticker.add((ticker) => {
          let nowTime = new Date;
          let isTouchedByWallByTop = false;
          let isTouchedByWallByLeft = false;
          let isTouchedByWallByBottom = false;
          let isTouchedByWallByRight = false;

          //keysDiv.innerHTML = JSON.stringify(keys);
          elapsed += ticker.deltaTime;

          if (!isWallSpawning) {
            setTimeout(spawnWall, 500);
            isWallSpawning = true;
          }



          

          wallSprites.forEach(wall => {



            if (sprite.y + sprite.height > wall.y - speedOfPlayer && sprite.y <= wall.y  && sprite.x >= wall.x && sprite.x <= wall.x + wall.width) {
              isTouchedByWallByBottom = true;
            }

            if (sprite.y < wall.y + wall.height + speedOfPlayer && sprite.y >= wall.y + wall.height && sprite.x >= wall.x && sprite.x <= wall.x + wall.width) {
              isTouchedByWallByTop = true;
            }


            if (sprite.x + sprite.width > wall.x - speedOfPlayer && sprite.x <= wall.x  && sprite.y >= wall.y && sprite.y <= wall.y + wall.height) {
              isTouchedByWallByRight = true;
              sprite.x -= speedOfWalls;
            }
            
            if (sprite.x < wall.x + wall.width + speedOfPlayer && sprite.x >= wall.x + wall.width && sprite.y >= wall.y && sprite.y <= wall.y + wall.height) {
              isTouchedByWallByLeft = true;
            }


            console.log(isTouchedByWallByTop);
          

          wall.x -=speedOfWalls;

          if(wall.x + wall.width < 0) {
            app.stage.removeChild(wall);
            wallSprites.shift(wall);
            console.log(wallSprites.length);
          }
          
          });

          movementControll(isTouchedByWallByRight, isTouchedByWallByLeft, isTouchedByWallByTop, isTouchedByWallByBottom);
          //console.log(isTouchedByWallByRight);
          
          //sprite.x = 100.0 + Math.cos(elapsed/50.0) * 100.0;
          
        });
    </script>
  </body>
</html>