<!doctype html>
<html>

<head>
  <script src="https://pixijs.download/release/pixi.js"></script>
</head>

<body>
  <button id="fullscreen-btn">Fullscreen</button>
  <script type="module">

    function keyDown(e) {
      console.log(e.keyCode);
      keys[e.keyCode] = true;
    }

    function keyUp(e) {
      console.log(e.keyCode);
      keys[e.keyCode] = false;
    }

    function movementControll(isTouchedByWallByRight, isTouchedByWallByLeft, isTouchedByWallByTop, isTouchedByWallByBottom) {
      if (!isTouchedByWallByTop) {
        if (keys["38"]) {
          sprite.y -= 3;
        }
      }
      if (!isTouchedByWallByBottom) {
        if (keys["40"]) {
          sprite.y += 3;
        }
      }
      if (!isTouchedByWallByLeft) {
        if (keys["37"]) {
          sprite.x -= 3;
        }
      }
      if (!isTouchedByWallByRight) {
        if (keys["39"]) {
          sprite.x += 3;
        }
      }

    }
    const app = new PIXI.Application();
    let keys = {};
    let keysDiv;
    let wallSprites = [];
    let timeStart = new Date;
    let startedSpawning = false
    await app.init({ background: 'black', width: 640, height: 360 });

    document.body.appendChild(app.canvas);

    // Create the sprite and add it to the stage
    await PIXI.Assets.load('square.png');
    let sprite = PIXI.Sprite.from('square.png');
    sprite.width = 50;
    sprite.height = 50;
    app.stage.addChild(sprite);

    window.addEventListener("keydown", keyDown);
    window.addEventListener("keyup", keyUp);
    keysDiv = document.querySelector("#keys");
    // Add a ticker callback to move the sprite back and forth
    let elapsed = 0.0;
    app.ticker.add((ticker) => {
      let nowTime = new Date;
      let isTouchedByWallByTop = false;
      let isTouchedByWallByLeft = false;
      let isTouchedByWallByBottom = false;
      let isTouchedByWallByRight = false;

      //keysDiv.innerHTML = JSON.stringify(keys);
      elapsed += ticker.deltaTime;

      if (nowTime.getSeconds() - timeStart.getSeconds() >= 5 && !startedSpawning) {
        startedSpawning = true;
        console.log("spawn");
        let wallSprite = PIXI.Sprite.from('square.png');
        wallSprite.width = 50;
        wallSprite.height = 50;
        wallSprite.x = 600;
        app.stage.addChild(wallSprite);
        wallSprites.push(wallSprite);
      }

      wallSprites.forEach(wall => {
        if (sprite.x < wall.x + wall.width
          && sprite.x + sprite.width > wall.x
          && sprite.y < wall.y + wall.height
          && sprite.y + sprite.height > wall.y) {
          if (sprite.x < wall.x + wall.width) {
            isTouchedByWallByRight = true;
            sprite.x -= 2;
          }

          if (sprite.x + sprite.width > wall.x) {
            isTouchedByWallByLeft = true;
          }
          if (sprite.y < wall.y + wall.height) {
            isTouchedByWallByTop = true;
          }
          if (sprite.y + sprite.height > wall.y) {
            isTouchedByWallByBottom = true;
          }

        }

        wall.x -= 2;
      });

      movementControll(isTouchedByWallByRight, isTouchedByWallByLeft, isTouchedByWallByTop, isTouchedByWallByBottom);
      // Fullscreen.js
      function toggleFullScreen() {
        const elem = document.documentElement;
        if (!document.fullscreenElement) {
          if (elem.requestFullscreen) {
            elem.requestFullscreen();
          } else if (elem.mozRequestFullScreen) { // Firefox
            elem.mozRequestFullScreen();
          } else if (elem.webkitRequestFullscreen) { // Chrome, Safari and Opera
            elem.webkitRequestFullscreen();
          } else if (elem.msRequestFullscreen) { // IE/Edge
            elem.msRequestFullscreen();
          }
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.mozCancelFullScreen) { // Firefox
            document.mozCancelFullScreen();
          } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) { // IE/Edge
            document.msExitFullscreen();
          }
        }
      }

      document.getElementById('fullscreen-btn').addEventListener('click', toggleFullScreen);




      //sprite.x = 100.0 + Math.cos(elapsed/50.0) * 100.0;

    });
  </script>
</body>

</html>